---
import Base from "../../layouts/Base.astro";
import CampaignCharts from "../../components/CampaignCharts";
import { getAllCampaigns, getEncounterSet, getCampaignCards } from "../../data";
import type { Campaign } from "../../data";
import { routes } from "../../routes";

export function getStaticPaths() {
  return getAllCampaigns().map((c) => ({
    params: { code: c.code },
    props: { campaign: c },
  }));
}

interface Props {
  campaign: Campaign;
}

const { campaign } = Astro.props;
const cards = getCampaignCards(campaign);

function aggregate(countBy: "unique" | "total") {
  const typeMap = new Map<string, number>();
  const traitMap = new Map<string, number>();
  for (const card of cards) {
    const n = countBy === "total" ? card.quantity : 1;
    typeMap.set(card.typeName, (typeMap.get(card.typeName) ?? 0) + n);
    if (card.traits) {
      for (const t of card.traits.split(". ").map((s) => s.replace(/\.$/, "").trim()).filter(Boolean)) {
        traitMap.set(t, (traitMap.get(t) ?? 0) + n);
      }
    }
  }
  const sort = (m: Map<string, number>) =>
    [...m.entries()].map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
  return { typeCounts: sort(typeMap), traitCounts: sort(traitMap) };
}

const unique = aggregate("unique");
const total = aggregate("total");

const chartCards = cards.map((c) => ({
  code: c.code,
  name: c.name,
  typeName: c.typeName,
  typeCode: c.typeCode,
  imageUrl: c.imageUrl,
  traits: c.traits,
}));

const seen = new Set<string>();
const encounterCodes: string[] = [];
for (const s of campaign.scenarios) {
  for (const ec of s.encounterCodes) {
    if (!seen.has(ec)) {
      seen.add(ec);
      encounterCodes.push(ec);
    }
  }
}
---

<Base title={campaign.name}>
  <h1>{campaign.name}</h1>

  <div class="scenario-grid">
    {campaign.scenarios.map((s) => (
      <a href={routes.scenario(s.code)} class="scenario-card">
        <div class="scenario-card-header">
          <img src={routes.icon(s.code)} alt="" class="scenario-icon" />
          <div class="scenario-card-info">
            {s.header && <div class="scenario-header-label">{s.header}</div>}
            <div class="scenario-name">{s.name}</div>
          </div>
        </div>
      </a>
    ))}
  </div>

  <div class="stats-grid">
    <section class="encounter-list">
      <h2>Encounter Sets</h2>
      <div class="encounter-tags">
        {encounterCodes.map((ec) => {
          const es = getEncounterSet(ec);
          if (!es) return null;
          return (
            <a href={routes.encounter(es.code)} class="encounter-tag">
              <img src={routes.icon(es.code)} alt="" class="encounter-icon" />
              {es.name}
            </a>
          );
        })}
      </div>
    </section>
    <CampaignCharts unique={unique} total={total} cards={chartCards} client:visible />
  </div>
</Base>

<style>
  h1 {
    margin-bottom: 1.5rem;
  }

  .scenario-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-bottom: 2rem;
  }

  .scenario-card {
    display: flex;
    padding: 0.5rem 0.75rem;
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    transition: border-color 0.15s;
  }

  .scenario-card:hover {
    border-color: var(--accent);
  }

  .scenario-card-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .scenario-icon {
    width: 28px;
    height: 28px;
    flex-shrink: 0;
    filter: invert(73%) sepia(15%) saturate(497%) hue-rotate(169deg) brightness(95%) contrast(88%);
  }

  .scenario-header-label {
    color: var(--text-muted);
    font-size: 0.7rem;
  }

  .scenario-name {
    font-weight: 600;
    font-size: 0.85rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.2rem;
    align-items: start;
  }

  .stats-grid > :global(astro-island) {
    display: contents;
  }

  @media (max-width: 700px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }

  .encounter-list h2 {
    font-size: 1.1rem;
    margin: 0 0 0.75rem;
  }

  .encounter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .encounter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    background: var(--bg-2);
    border-radius: 4px;
    color: var(--text-secondary);
  }

  .encounter-icon {
    width: 14px;
    height: 14px;
    filter: invert(73%) sepia(15%) saturate(497%) hue-rotate(169deg) brightness(95%) contrast(88%);
  }

  .encounter-tag:hover {
    color: var(--accent);
  }
</style>
